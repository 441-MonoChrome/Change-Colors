<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr"> 
<head>

<script>


var CssToInject;

var IsOverrideAll;
var IsPageOverriden;
var IsDomainOverriden;
var IsNotPageOverriden;
var IsNotDomainOverriden;

var OverridenDomains = new Array();
var OverridenPages = new Array();
var NotOverridenDomains = new Array();
var NotOverridenPages = new Array();

var OverrideAll;

var CurrentTabId;

function loadOption(optionName){
    return JSON.parse(localStorage[optionName]);   
}


chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
      switch(request.shortCut){
      case "overridePage":
	  if(IsPageOverriden)
	      RemovePageOverride();
	  else
	      ApplyPageOverride();
	  break;
      case "overrideDomain":
	  if(IsDomainOverriden)
	      RemoveDomainOverride();
	  else
	      ApplyDomainOverride();
	  break;
      case "overrideAll":
	  if(IsOverrideAll)
	      RemoveOverrideAll();
	  else
	      ApplyOverrideAll();
	  break;
      }
  }
);


function buildCssToInject(){

    var backgroundColor = '#' + loadOption("background_color");
    var textColor = '#' + loadOption("text_color");
    var linksColor = '#' + loadOption("links_color");
    var visitedLinksColor = '#' + loadOption("visited_links_color");
    var fontName = loadOption("OverrideFontName");
    var fontSize = loadOption("FontSize");
    var defaultBrowserFont = loadOption("DefaultBrowserFont");
    var defaultBrowserColor = loadOption("DefaultBrowserColor");
    var showImages = loadOption("ShowImage");

    if(defaultBrowserColor != true){
    var css =  'html > body, html > body * {' + 
               'background-color: '+ backgroundColor +' !important;' +
	       'color: ' + textColor + ' !important;' + 
               'text-shadow: 0 !important;' +
               '-webkit-text-fill-color: none !important;}' +
               'html > body, html > body *:not([onclick]):not(:link):not(:visited) {' +
               'background-image: none !important;}' +
               'html > body a:link, html > body a:link *,' +
               'html > body a:link:hover, html > body a:link:hover *,' +
               'html > body a:link:active, html > body a:link:active * {' +
               'color: ' + linksColor + ' !important;}' +
               'html > body a:visited, html > body a:visited *,' +
               'html > body a:visited:hover, html > body a:visited:hover *,' +
               'html > body a:visited:active, html > body a:visited:active * {' +
               'color:' +  visitedLinksColor + ' !important;}';
    }
    if(defaultBrowserFont != true){
	css += 'html > body, html > body * {' +
               'font-family: '+ fontName  +' !important;'+ 
	       'font-size: '+ fontSize +'pt }';
    }
    if (!showImages) {
	css += 'html > body img { display:none !important; }';
    }
    CssToInject = css;
}

function callInjectCss(){
  chrome.tabs.sendRequest(CurrentTabId, {action: "injectCss", css: CssToInject} , null);
}

function callRemoveCss(){
  chrome.tabs.sendRequest(CurrentTabId, {action: "removeCss"}, null);
}

function extractDomain(url){
    return url.match(/:\/\/(.+?)\//)[1];
}

function checkIfDomainOverriden(domain){    
    IsDomainOverriden = OverridenDomains.indexOf(domain) != -1;
}

function checkIfPageOverriden(path){
    IsPageOverriden = OverridenPages.indexOf(path) != -1;
}

function checkIfNotDomainOverriden(domain){    
    IsNotDomainOverriden = NotOverridenDomains.indexOf(domain) != -1;
}

function checkIfNotPageOverriden(path){
    IsNotPageOverriden = NotOverridenPages.indexOf(path) != -1;
}

function checkIfOverrideAll(){
    return IsOverrideAll;
}

function RemovePageOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	OverridenPages.splice(OverridenPages.indexOf(tab.url),1);
	localStorage["OverridenPages"]  = JSON.stringify(OverridenPages);
    });    
    IsPageOverriden = false;
    callRemoveCss();
}

function RemoveNoPageOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	NotOverridenPages.splice(OverridenPages.indexOf(tab.url),1);
	localStorage["NotOverridenPages"]  = JSON.stringify(OverridenPages);
    });    
    IsNotPageOverriden = false;
    callInjectCss();
}


function RemoveDomainOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	domain = extractDomain(tab.url);
	OverridenDomains.splice(OverridenDomains.indexOf(domain),1);
	localStorage["OverridenDomains"]  = JSON.stringify(OverridenPages);
    });
    IsDomainOverriden = false;
    callRemoveCss();
}

function RemoveNoDomainOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	domain = extractDomain(tab.url);
	NotOverridenDomains.splice(NotOverridenDomains.indexOf(domain),1);
	localStorage["NotOverridenDomains"]  = JSON.stringify(OverridenPages);
    });
    IsNotDomainOverriden = false;
    callInjectCss();
}


function RemoveOverrideAll(){
    localStorage["OverrideAll"]  = JSON.stringify(false);
    IsOverrideAll = false;
    callRemoveCss();
}

function ApplyPageOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	OverridenPages.push(tab.url)	
	localStorage["OverridenPages"]  = JSON.stringify(OverridenPages);
    });
    IsPageOverriden = true;
    callInjectCss();
}

function ApplyNoPageOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	NotOverridenPages.push(tab.url)	
	localStorage["NotOverridenPages"]  = JSON.stringify(NotOverridenPages);
    });
    IsNotPageOverriden = true;
    callRemoveCss();
}


function ApplyDomainOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	OverridenDomains.push(extractDomain(tab.url))	
	localStorage["OverridenDomains"]  = JSON.stringify(OverridenDomains);
    });
    IsDomainOverriden = true;
    callInjectCss();
}

function ApplyNoDomainOverride(){
    chrome.tabs.get(CurrentTabId, function (tab){
	NotOverridenDomains.push(extractDomain(tab.url))	
	localStorage["NotOverridenDomains"]  = JSON.stringify(NotOverridenDomains);
    });
    IsNotDomainOverriden = true;
    callRemoveCss();
}

function ApplyOverrideAll(){
    localStorage["OverrideAll"]  = JSON.stringify(true);
    IsOverrideAll = true;
    callInjectCss();
}

function IsStyleOverriden(url){
    var domain = extractDomain(url);
    checkIfOverrideAll();
    checkIfNotPageOverriden(url);
    checkIfNotDomainOverriden(domain);
    checkIfPageOverriden(url);
    checkIfDomainOverriden(domain);
    return (IsOverrideAll && !(IsNotPageOverriden || IsNotDomainOverriden)) || IsPageOverriden || IsDomainOverriden;
}


function displayDefault(tabId)
{
    chrome.pageAction.setIcon({tabId: tabId, path: "icons/colors_icons.png"});
}


function displayOverriden(tabId)
{
    chrome.pageAction.setIcon({tabId: tabId, path: "icons/colors_icons.png"});
}


function updatePageAction(tabId){
    CurrentTabId = tabId
    chrome.tabs.get(tabId, function (tab){
	
	if(IsStyleOverriden(tab.url)){	    
	    callInjectCss();
	    displayOverriden(tab.id);
	}
	else
	    displayDefault(tab.id);
	chrome.pageAction.show(tabId);
    });
}

function saveOption(optionName, optionValue){
    localStorage[optionName]  = JSON.stringify(optionValue);    
}


function setDefaultOption(optionName, value){
    if(localStorage[optionName] == undefined){
	saveOption(optionName, value);
    }
}

function setDefaults(){
    setDefaultOption("OverridenDomains", new Array());
    setDefaultOption("OverridenPages", new Array());
    setDefaultOption("NotOverridenDomains", new Array());
    setDefaultOption("NotOverridenPages", new Array());
    setDefaultOption("OverrideAll", false);
    setDefaultOption("IsNotFirstStart", true);
    setDefaultOption("DefaultBrowserFont", true);
    setDefaultOption("DefaultBrowserColor", false);
    setDefaultOption("text_color", "E8E8E8");
    setDefaultOption("background_color", "080808");
    setDefaultOption("links_color", "2E79DB");
    setDefaultOption("visited_links_color", "9B51DB");
    setDefaultOption("FontSize", "11");
    setDefaultOption("ShowImage", true);
    setDefaultOption("OverrideFontName", "Arial");
}


function getOverrides(){
    OverridenDomains = JSON.parse(localStorage["OverridenDomains"]);
    OverridenPages = JSON.parse(localStorage["OverridenPages"]);
    IsOverrideAll = JSON.parse(localStorage["OverrideAll"]);
}

setDefaults();
getOverrides();
buildCssToInject();
chrome.tabs.onUpdated.addListener(updatePageAction);
chrome.tabs.onSelectionChanged.addListener(updatePageAction);

</script>
</head>
<body>
</body>
</html>

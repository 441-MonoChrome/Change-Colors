<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr"> 
<head>

<script>

function CurrentPage ()
{

this.blnOverrides = {'OverridenDomains' : null,
		     'OverridenPages' : null,
		     'NotOverridenPages' : null,
		     'NotOverridenDomains' : null,
		     'OverrideAll': null
		    }
this.Overrides = {'OverridenDomains' : new Array(), 
		  'OverridenPages' : new Array(), 
		  'NotOverridenPages' : new Array(), 
		  'NotOverridenDomains' : new Array, 
		  'OverrideAll' : null
		 }
this.CurrentTabId;
this.Url;
this.Domain;
this.setDefaults();
this.getOverrides();
this.CssToInject = buildCssToInject();
}


CurrentPage.prototype.getOverrides = function (){
    this.Overrides['OverridenDomains'] = JSON.parse(localStorage["OverridenDomains"]);
    this.Overrides['OverridenPages'] = JSON.parse(localStorage["OverridenPages"]);
    this.Overrides['NotOverridenDomains'] = JSON.parse(localStorage["NotOverridenDomains"]);
    this.Overrides['NotOverridenPages'] = JSON.parse(localStorage["NotOverridenPages"]);
    this.Overrides['OverrideAll'] = JSON.parse(localStorage["OverrideAll"]);
}

CurrentPage.prototype.callInjectCss = function (){
  chrome.tabs.sendRequest(this.CurrentTabId, {action: "injectCss", css: this.CssToInject} , null);
}

CurrentPage.prototype.callRemoveCss = function (){
  chrome.tabs.sendRequest(this.CurrentTabId, {action: "removeCss"}, null);
}

CurrentPage.prototype.setIsOverridenOrNot =  function (path, overrideType){
    this.blnOverrides[overrideType] = this.Overrides[overrideType].indexOf(path) != 1;
}

CurrentPage.prototype.applyOverride = function (overrideType, path){
    this.Overrides[overrideType].push(path);
    this.manageOverride(overrideType, true, this.Overrides[overrideType], this.callInjectCss);
}

CurrentPage.prototype.removeOverride = function (overrideType, path){
    this.Overrides[overrideType].splice(this.Overrides[overrideType].indexOf(path),1);
    this.manageOverride(overrideType, false, this.Overrides[overrideType], this.callRemoveCss);
}

CurrentPage.prototype.manageOverride = function (overrideType, blnValue, localStorageValue, CSSfn){
    localStorage[overrideType]  = JSON.stringify(localStorageValue);
    this.blnOverrides[overrideType] = blnValue;
    CSSfn();
}

CurrentPage.prototype.manageOverride = function (overrideType, blbOverrideValue, actionFn){
}

CurrentPage.prototype.IsStyleOverriden = function(url){
    var domain = extractDomain(url);
    this.setIsOverridenOrNot(url, 'NotOverridenPages');
    this.setIsOverridenOrNot(domain, 'NotOverridenDomains');
    this.setIsOverridenOrNot(url, 'OverridenPages');
    this.setIsOverridenOrNot(url, 'OverridenDomains');
    return (this.blnOverrides['OverrideAll'] && !(this.blnOverrides['NotOverridenPages'] || this.blnOverrides['NotOverridenDomains'])) || this.blnOverrides['OverridenPages'] || this.blnOverrides['OverridenDomains'];
}

CurrentPage.prototype.setDefaults = function (){
    setDefaultOption("OverridenDomains", new Array());
    setDefaultOption("OverridenPages", new Array());
    setDefaultOption("NotOverridenDomains", new Array());
    setDefaultOption("NotOverridenPages", new Array());
    setDefaultOption("OverrideAll", false);
    setDefaultOption("IsNotFirstStart", true);
    setDefaultOption("DefaultBrowserFont", true);
    setDefaultOption("DefaultBrowserColor", false);
    setDefaultOption("text_color", "E8E8E8");
    setDefaultOption("background_color", "080808");
    setDefaultOption("links_color", "2E79DB");
    setDefaultOption("visited_links_color", "9B51DB");
    setDefaultOption("FontSize", "11");
    setDefaultOption("ShowImage", true);
    setDefaultOption("OverrideFontName", "Arial");
}

CurrentPage.prototype.updatePageAction = function(tabId){
    chrome.tabs.get(tabId, function (tab){
	this.CurrentTabId = tab.id;
	this.Url = tab.url;
	this.Domain = extractDomain(this.Url);
	if(IsStyleOverriden(tab.url)){	    
	    this.callInjectCss();
	    this.displayOverriden(tab.id);
	}
	else
	    this.displayDefault(tab.id);
	chrome.pageAction.show(tabId);
    });
}


CurrentPage.prototype.displayDefault = function(tabId){
    chrome.pageAction.setIcon({tabId: tabId, path: "icons/colors_icons.png"});
}


CurrentPage.prototype.displayOverriden = function(tabId){
    chrome.pageAction.setIcon({tabId: tabId, path: "icons/colors_icons.png"});
}


function extractDomain(url){
    return url.match(/:\/\/(.+?)\//)[1];
}


function loadOption(optionName){
    return JSON.parse(localStorage[optionName]);   
}


function saveOption(optionName, optionValue){
    localStorage[optionName]  = JSON.stringify(optionValue);    
}


function setDefaultOption(optionName, value){
    if(localStorage[optionName] == undefined){
	saveOption(optionName, value);
    }
}


function buildCssToInject(){
    var backgroundColor = '#' + loadOption("background_color");
    var textColor = '#' + loadOption("text_color");
    var linksColor = '#' + loadOption("links_color");
    var visitedLinksColor = '#' + loadOption("visited_links_color");
    var fontName = loadOption("OverrideFontName");
    var fontSize = loadOption("FontSize");
    var defaultBrowserFont = loadOption("DefaultBrowserFont");
    var defaultBrowserColor = loadOption("DefaultBrowserColor");
    var showImages = loadOption("ShowImage");

    if(defaultBrowserColor != true){
    var css =  'html > body, html > body * {' + 
               'background-color: '+ backgroundColor +' !important;' +
	       'color: ' + textColor + ' !important;' + 
               'text-shadow: 0 !important;' +
               '-webkit-text-fill-color: none !important;}' +
               'html > body, html > body *:not([onclick]):not(:link):not(:visited) {' +
               'background-image: none !important;}' +
               'html > body a:link, html > body a:link *,' +
               'html > body a:link:hover, html > body a:link:hover *,' +
               'html > body a:link:active, html > body a:link:active * {' +
               'color: ' + linksColor + ' !important;}' +
               'html > body a:visited, html > body a:visited *,' +
               'html > body a:visited:hover, html > body a:visited:hover *,' +
               'html > body a:visited:active, html > body a:visited:active * {' +
               'color:' +  visitedLinksColor + ' !important;}';
    }
    if(defaultBrowserFont != true){
	css += 'html > body, html > body * {' +
               'font-family: '+ fontName  +' !important;'+ 
	       'font-size: '+ fontSize +'pt }';
    }
    if (!showImages) {
	css += 'html > body img { display:none !important; }';
    }
    return css;
}

var objCurrentPage = new CurrentPage;

chrome.tabs.onUpdated.addListener(CurrentPage.updatePageAction);
chrome.tabs.onSelectionChanged.addListener(CurrentPage.updatePageAction);

chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
      switch(request.shortCut){
      case "overridePage":
	  if(objCurrentPage.IsPageOverriden)
	      objCurrentPage.removeOverride('OverridenPages', this.Url);
	  else
	      objCurrentPage.applyOverride('OverridenPages', this.Url);
	  break;
      case "overrideDomain":
	  if(IsDomainOverriden)
	      objCurrentPage.removeOverride('OverridenDomains', this.Domain);
	  else
	      objCurrentPage.applyOverride('OverridenDomains', this.Domain);
	  break;
      case "overrideAll":
	  if(IsOverrideAll)
	      objCurrentPage.manageOverride('OverrideAll', false, false, this.callRemoveCss);
	  else
	      objCurrentPage.manageOverride('OverrideAll', true, true, this.callInjectCss);
	  break;
      }
  }
);

</script>
</head>
<body>
</body>
</html>
